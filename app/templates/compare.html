{% extends "base.html" %}
{% block content %}
    <form method="post" action="{{ url_for('compare') }}" autocomplete="off" id="user-form">
        <label for="selected_user">Select user to compare:</label>
        <select name="selected_user" id="selected_user" onchange="updateDatesDropdown()">
            {% for other_user in other_users %}
                <option value="{{ other_user.id }}" {% if selected_user and selected_user.id == other_user.id %}selected{% endif %}>
                    {{ other_user.username }}
                </option>
            {% endfor %}
        </select>

        <button type="submit" name="submit_user">Compare by User</button>
    </form>

    <label for="selected_date">Select date to compare:</label>
    <select name="selected_date" id="selected_date">
        <option value="overall" {% if selected_date == 'overall' %}selected{% endif %}>Overall Comparison</option>
        {% for date in common_dates %}
            <option value="{{ date }}">{{ date }}</option>
        {% endfor %}
    </select>

    <h4>Runs of {{ user.username }}:</h4>
    <ul>
        {% for run in user_runs %}
            <li>{{ run.date }} - Distance: {{ run.distance }} km, Duration: {{ run.duration }} </li>
        {% endfor %}
    </ul>
    {% if selected_user %}
        <h4>Runs of {{ selected_user.username }}:</h4>
        <ul>
            {% for run in selected_user_runs %}
                <li>{{ run.date }} - Distance: {{ run.distance }} km, Duration: {{ run.duration }} </li>
            {% endfor %}
        </ul>
    {% endif %}

    {% if selected_date %}
        <h4>Comparison for: {{ selected_date }}</h4>
    {% endif %}

    <h3><a href="{{ url_for('day_display') }}">Home</a></h3>

    <script>
        function updateDatesDropdown() {
            var userDates = {{ user_dates | tojson | safe }};

            var selectedUserId = document.getElementById('selected_user').value;

            // Convert userDates to JSON format
            var userDatesJSON = JSON.stringify(userDates);

            // Make an AJAX request to get common_dates for the selected user
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/get_common_dates/' + selectedUserId + '?user_dates=' + userDatesJSON, true);

            xhr.onload = function () {
                if (xhr.status === 200) {
                    // Parse the response JSON
                    var commonDates = JSON.parse(xhr.responseText);

                    // Update the options in the dates dropdown
                    var dateDropdown = document.getElementById('selected_date');
                    dateDropdown.innerHTML = ''; // Clear existing options

                    // Add 'Overall Comparison' option
                    var overallOption = document.createElement('option');
                    overallOption.value = 'overall';
                    overallOption.text = 'Overall Comparison';
                    dateDropdown.appendChild(overallOption);

                    // Add options for common dates
                    for (var i = 0; i < commonDates.length; i++) {
                        var dateOption = document.createElement('option');
                        dateOption.value = commonDates[i];
                        dateOption.text = commonDates[i];
                        dateDropdown.appendChild(dateOption);
                    }
                }
            };

            xhr.send();
        }
    </script>
{% endblock %}
